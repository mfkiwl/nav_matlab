close all;
clear;
clc;
format short;

R2D = 180/pi;       % Rad to Deg
D2R = pi/180;       % Deg to Rad
GRAVITY = 9.8;     % 重力加速度

%% 加载数据
% fullfilename  = "./mag_test.csv";
%
% T = readtable(fullfilename); % 读取 CSV 文件
% frame_name = table2cell(T(:,1));

% gyr = [T.gyr_x T.gyr_y T.gyr_z];
% mag = [T.mag_x T.mag_y T.mag_z];

raw_data  = [
13.98,20.31,-22.63,0.999,-0.018,0.041,-0.000
14.21,20.08,-22.29,0.999,-0.017,0.041,-0.000
14.33,20.23,-22.46,0.999,-0.018,0.042,-0.000
14.06,19.73,-22.79,0.999,-0.017,0.042,0.000
14.25,19.85,-22.46,0.999,-0.017,0.042,0.001
13.98,19.77,-22.63,0.999,-0.016,0.042,0.001
14.25,20.08,-22.75,0.999,-0.017,0.042,0.000
13.89,19.96,-22.63,0.999,-0.017,0.042,0.000
13.77,20.00,-22.46,0.999,-0.017,0.042,0.000
13.89,19.92,-22.67,0.999,-0.017,0.042,0.000
13.98,20.17,-22.46,0.999,-0.016,0.042,0.000
13.81,20.39,-22.58,0.999,-0.017,0.042,-0.000
13.81,19.81,-22.54,0.999,-0.017,0.042,-0.000
14.02,19.77,-22.42,0.999,-0.016,0.042,0.000
13.73,20.04,-22.79,0.999,-0.016,0.041,0.001
14.02,19.96,-23.04,0.999,-0.016,0.042,0.000
13.89,20.00,-22.96,0.999,-0.016,0.042,-0.000
13.98,20.17,-22.58,0.999,-0.017,0.042,-0.000
13.58,20.39,-22.79,0.999,-0.016,0.042,-0.000
14.21,20.17,-22.79,0.999,-0.016,0.042,0.000
13.89,19.85,-22.71,0.999,-0.015,0.042,0.001
14.06,19.81,-22.71,0.999,-0.015,0.042,0.001
13.93,19.73,-22.54,0.999,-0.015,0.042,0.001
14.06,20.04,-22.54,0.999,-0.015,0.042,0.000
14.25,20.04,-22.75,0.999,-0.015,0.042,0.000
14.21,19.92,-22.67,0.999,-0.015,0.043,0.000
14.29,19.92,-22.38,0.999,-0.015,0.043,0.000
14.02,19.96,-22.92,0.999,-0.015,0.043,0.000
14.33,19.96,-22.88,0.999,-0.014,0.042,0.000
14.06,19.77,-23.04,0.999,-0.015,0.042,0.000
14.10,19.96,-22.67,0.999,-0.016,0.042,0.000
13.68,19.64,-23.17,0.999,-0.017,0.041,0.000
13.93,20.27,-22.67,0.999,-0.018,0.040,0.000
13.93,20.71,-22.21,0.999,-0.021,0.040,0.000
13.81,20.71,-22.25,0.999,-0.027,0.039,0.001
13.93,20.81,-21.71,0.999,-0.037,0.036,0.000
13.68,21.38,-21.21,0.998,-0.051,0.033,-0.000
13.54,22.18,-20.46,0.997,-0.066,0.031,-0.000
13.85,22.68,-19.63,0.996,-0.081,0.031,-0.001
13.98,23.00,-18.92,0.995,-0.092,0.031,-0.000
13.58,23.48,-17.96,0.995,-0.100,0.030,0.001
13.58,23.79,-17.58,0.994,-0.104,0.029,0.002
13.63,23.67,-17.79,0.994,-0.101,0.031,0.003
13.89,23.89,-17.79,0.995,-0.097,0.033,0.005
14.29,23.79,-17.92,0.995,-0.088,0.037,0.007
15.14,22.38,-19.38,0.996,-0.074,0.040,0.010
14.93,22.27,-20.38,0.997,-0.060,0.043,0.013
15.38,20.93,-21.29,0.998,-0.044,0.047,0.016
15.73,19.96,-22.04,0.998,-0.030,0.051,0.020
15.93,19.77,-22.38,0.998,-0.015,0.055,0.024
16.38,18.33,-23.42,0.998,0.004,0.061,0.027
17.50,17.27,-24.29,0.997,0.027,0.071,0.029
17.81,15.64,-25.92,0.994,0.054,0.085,0.030
18.54,14.00,-26.25,0.991,0.085,0.099,0.030
19.10,12.29,-27.50,0.987,0.112,0.108,0.031
19.18,10.96,-28.33,0.985,0.130,0.113,0.032
18.98,10.81,-28.79,0.983,0.141,0.116,0.032
19.25,10.38,-28.67,0.983,0.143,0.115,0.030
18.93,11.23,-28.04,0.985,0.132,0.111,0.027
18.46,12.39,-28.00,0.988,0.116,0.103,0.024
18.21,13.23,-27.17,0.991,0.098,0.092,0.024
17.42,14.31,-26.67,0.993,0.079,0.080,0.027
17.10,15.08,-26.04,0.995,0.063,0.067,0.030
16.63,15.92,-25.58,0.997,0.047,0.052,0.032
15.89,16.81,-25.29,0.998,0.030,0.038,0.033
15.50,17.27,-24.88,0.999,0.015,0.026,0.034
15.02,18.06,-24.54,0.999,0.004,0.016,0.034
14.81,18.60,-24.67,0.999,-0.004,0.009,0.035
14.50,18.92,-24.00,0.999,-0.008,0.006,0.035
14.63,19.02,-24.21,0.999,-0.007,0.006,0.034
14.68,18.60,-24.50,0.999,-0.000,0.012,0.034
15.54,17.89,-25.42,0.999,0.014,0.022,0.034
15.89,17.08,-25.50,0.998,0.032,0.034,0.034
16.38,15.96,-26.04,0.997,0.049,0.044,0.034
16.58,14.85,-26.96,0.996,0.067,0.049,0.035
16.89,14.23,-27.96,0.994,0.083,0.054,0.037
17.63,13.73,-28.00,0.993,0.092,0.057,0.040
17.85,12.60,-27.75,0.993,0.097,0.060,0.042
17.77,12.52,-28.00,0.993,0.096,0.060,0.041
17.33,13.02,-28.13,0.993,0.091,0.058,0.041
17.33,13.14,-27.71,0.995,0.080,0.055,0.040
16.77,13.81,-27.17,0.996,0.062,0.049,0.038
16.54,14.98,-26.25,0.998,0.041,0.042,0.037
16.21,16.46,-25.58,0.999,0.019,0.035,0.036
15.85,17.63,-24.46,0.999,-0.001,0.030,0.035
15.77,18.79,-23.38,0.999,-0.022,0.026,0.035
15.50,19.92,-22.38,0.998,-0.042,0.023,0.035
15.73,21.17,-21.21,0.998,-0.054,0.024,0.035
15.42,21.38,-20.38,0.997,-0.064,0.028,0.036
16.63,21.56,-20.04,0.996,-0.069,0.038,0.035
17.02,21.64,-20.00,0.996,-0.067,0.055,0.032
17.42,21.33,-20.13,0.995,-0.057,0.075,0.028
17.63,20.71,-20.21,0.995,-0.054,0.084,0.025
17.98,20.63,-20.96,0.995,-0.047,0.088,0.029
18.67,19.68,-21.42,0.994,-0.030,0.095,0.033
19.25,18.71,-21.96,0.994,-0.014,0.104,0.037
19.54,18.25,-22.33,0.993,0.000,0.108,0.040
19.25,17.54,-22.71,0.994,0.009,0.105,0.043
18.98,17.63,-22.92,0.994,0.006,0.096,0.044
19.06,17.35,-22.96,0.995,0.005,0.084,0.044
18.33,17.54,-23.54,0.996,0.006,0.070,0.046
17.58,17.67,-24.13,0.997,0.009,0.054,0.050
17.50,17.43,-24.96,0.998,0.015,0.037,0.053
16.93,17.39,-25.29,0.998,0.019,0.019,0.056
15.68,17.23,-25.46,0.998,0.020,0.001,0.059
14.85,17.00,-25.71,0.998,0.018,-0.020,0.059
14.02,16.92,-26.38,0.997,0.016,-0.041,0.058
13.58,16.54,-27.00,0.996,0.023,-0.057,0.059
12.93,16.23,-27.58,0.996,0.033,-0.063,0.061
12.73,15.39,-28.00,0.995,0.045,-0.064,0.062
12.50,14.23,-29.17,0.994,0.062,-0.060,0.061
13.02,13.23,-29.92,0.993,0.086,-0.052,0.061
13.29,11.89,-30.88,0.991,0.111,-0.039,0.063
13.89,10.88,-31.17,0.989,0.127,-0.027,0.065
14.63,9.56,-31.71,0.988,0.135,-0.019,0.068
15.21,9.21,-31.25,0.988,0.139,-0.011,0.071
15.73,9.56,-31.13,0.988,0.136,-0.002,0.072
16.46,9.67,-30.63,0.990,0.125,0.009,0.072
16.98,11.00,-29.75,0.992,0.103,0.018,0.071
16.73,12.71,-28.79,0.995,0.074,0.024,0.067
17.06,14.67,-26.79,0.997,0.043,0.030,0.064
17.25,16.18,-25.33,0.997,0.015,0.035,0.060
17.42,17.71,-23.92,0.997,-0.014,0.041,0.059
17.73,18.75,-22.17,0.996,-0.037,0.051,0.061
18.14,20.48,-20.79,0.995,-0.053,0.060,0.062
18.67,20.63,-19.96,0.994,-0.069,0.063,0.062
18.77,21.83,-18.79,0.992,-0.085,0.063,0.063
18.63,21.96,-17.83,0.992,-0.094,0.062,0.063
19.18,22.58,-17.58,0.991,-0.100,0.057,0.065
18.10,22.14,-17.75,0.991,-0.101,0.049,0.067
18.06,21.79,-18.42,0.992,-0.097,0.040,0.070
17.77,21.79,-18.92,0.993,-0.086,0.030,0.073
17.63,21.25,-19.88,0.994,-0.072,0.018,0.075
17.21,20.58,-20.54,0.996,-0.052,0.008,0.077
16.77,19.18,-22.46,0.997,-0.028,0.002,0.079
16.63,17.93,-24.25,0.997,-0.004,0.000,0.078
16.58,16.60,-25.46,0.997,0.021,0.001,0.079
16.29,15.43,-26.96,0.996,0.049,0.005,0.080
17.10,13.64,-27.88,0.994,0.075,0.015,0.080
17.29,12.17,-28.46,0.992,0.093,0.026,0.077
17.77,11.71,-28.54,0.991,0.105,0.033,0.074
18.06,10.64,-29.13,0.989,0.119,0.040,0.071
17.85,10.23,-30.00,0.988,0.133,0.048,0.070
18.42,9.56,-29.63,0.986,0.140,0.058,0.070
19.10,9.71,-29.08,0.986,0.132,0.066,0.072
19.42,10.68,-28.46,0.988,0.115,0.073,0.072
19.73,12.29,-27.33,0.990,0.090,0.083,0.068
20.38,13.68,-25.96,0.991,0.063,0.095,0.065
20.25,15.13,-24.46,0.992,0.039,0.101,0.063
20.25,16.46,-23.54,0.993,0.015,0.099,0.061
19.50,17.75,-22.63,0.994,-0.007,0.095,0.060
19.42,19.02,-21.04,0.994,-0.031,0.088,0.057
19.02,20.00,-20.08,0.994,-0.054,0.077,0.055
18.29,21.17,-19.46,0.994,-0.073,0.064,0.056
18.10,21.33,-19.08,0.993,-0.087,0.050,0.060
17.46,22.06,-18.50,0.993,-0.095,0.033,0.063
17.33,22.68,-18.50,0.993,-0.100,0.013,0.065
16.73,22.54,-18.75,0.993,-0.100,-0.004,0.069
16.25,22.23,-19.54,0.993,-0.094,-0.015,0.072
16.46,21.92,-20.33,0.993,-0.084,-0.022,0.074
15.85,21.17,-21.13,0.995,-0.066,-0.026,0.075
15.58,20.54,-22.83,0.996,-0.044,-0.030,0.075
15.21,19.33,-23.58,0.996,-0.020,-0.031,0.076
15.38,17.31,-25.54,0.997,0.011,-0.025,0.079
15.85,15.75,-26.54,0.995,0.047,-0.013,0.082
16.33,13.68,-28.17,0.993,0.085,0.002,0.081
17.21,11.67,-29.29,0.989,0.120,0.019,0.080
17.77,9.21,-30.75,0.984,0.151,0.038,0.081
18.73,7.14,-30.92,0.979,0.175,0.056,0.084
19.81,6.13,-31.13,0.976,0.188,0.070,0.087
20.46,6.13,-30.79,0.977,0.179,0.077,0.089
20.63,7.02,-30.25,0.980,0.159,0.081,0.087
20.29,10.50,-28.33,0.985,0.126,0.084,0.082
20.71,12.60,-26.54,0.990,0.082,0.087,0.078
20.18,15.48,-24.50,0.993,0.033,0.086,0.072
19.98,17.00,-22.96,0.995,-0.019,0.078,0.066
18.54,20.48,-19.71,0.994,-0.062,0.068,0.062
18.21,21.52,-18.33,0.992,-0.089,0.058,0.061
18.10,23.04,-16.63,0.991,-0.111,0.047,0.065
17.98,23.98,-16.42,0.989,-0.127,0.034,0.069
17.73,23.89,-16.17,0.988,-0.134,0.022,0.072
17.38,23.63,-16.58,0.988,-0.134,0.013,0.073
17.46,23.43,-16.83,0.989,-0.128,0.007,0.075
17.10,23.23,-17.50,0.990,-0.117,0.001,0.077
17.38,22.50,-19.08,0.992,-0.100,-0.004,0.079
16.93,21.38,-20.54,0.994,-0.077,-0.007,0.082
17.14,20.08,-22.29,0.995,-0.052,-0.005,0.083
17.02,18.79,-23.38,0.996,-0.026,-0.001,0.084
17.50,17.39,-24.54,0.997,0.004,0.003,0.083
17.54,15.71,-25.96,0.996,0.033,0.009,0.083
17.33,14.13,-27.42,0.994,0.060,0.013,0.086
18.29,12.33,-28.67,0.992,0.088,0.019,0.090
18.38,10.92,-29.54,0.989,0.110,0.025,0.094
18.42,9.75,-29.75,0.987,0.121,0.030,0.097
18.29,9.75,-29.54,0.987,0.120,0.030,0.098
18.38,10.64,-29.08,0.990,0.104,0.027,0.096
18.38,11.93,-28.33,0.992,0.078,0.023,0.092
18.21,14.58,-26.58,0.995,0.038,0.016,0.088
17.29,17.13,-24.38,0.996,-0.014,0.007,0.083
16.98,20.23,-21.83,0.995,-0.067,-0.001,0.079
16.98,22.27,-18.92,0.991,-0.109,-0.007,0.076
16.54,23.48,-17.04,0.987,-0.142,-0.013,0.074
16.46,24.96,-15.29,0.982,-0.171,-0.020,0.076
16.85,25.68,-13.92,0.979,-0.185,-0.025,0.080
17.21,25.38,-13.58,0.978,-0.188,-0.026,0.086
17.46,25.10,-13.83,0.978,-0.187,-0.025,0.091
17.81,24.92,-13.83,0.978,-0.183,-0.020,0.093
18.25,24.43,-14.29,0.979,-0.179,-0.005,0.095
18.67,24.52,-14.33,0.982,-0.164,0.023,0.094
19.54,23.71,-15.13,0.985,-0.140,0.052,0.089
20.58,22.42,-16.04,0.986,-0.121,0.070,0.087
21.10,21.96,-17.21,0.988,-0.098,0.081,0.089
21.77,20.43,-18.25,0.988,-0.076,0.093,0.094
21.81,19.46,-19.29,0.988,-0.057,0.106,0.096
22.25,18.79,-19.54,0.989,-0.045,0.110,0.093
21.50,19.14,-20.42,0.990,-0.045,0.100,0.088
20.58,19.46,-20.29,0.992,-0.047,0.087,0.082
20.33,19.42,-21.00,0.993,-0.034,0.077,0.079
19.73,18.13,-22.79,0.995,-0.014,0.066,0.079
18.89,16.64,-23.96,0.996,0.006,0.047,0.080
17.85,16.18,-25.54,0.996,0.022,0.023,0.079
16.77,15.92,-26.63,0.997,0.029,-0.000,0.077
16.10,15.79,-26.63,0.997,0.033,-0.019,0.074
14.68,15.39,-27.96,0.996,0.044,-0.033,0.072
13.85,14.18,-28.29,0.995,0.057,-0.045,0.074
14.06,13.77,-29.04,0.993,0.064,-0.054,0.080
14.42,12.48,-29.79,0.991,0.084,-0.049,0.087
15.14,10.77,-30.75,0.989,0.106,-0.036,0.092
15.81,10.06,-31.04,0.988,0.118,-0.028,0.098
16.06,8.89,-31.67,0.986,0.132,-0.024,0.101
16.21,8.04,-31.79,0.984,0.142,-0.019,0.102
16.46,8.50,-31.67,0.985,0.139,-0.012,0.104
17.33,8.89,-30.83,0.986,0.126,-0.002,0.105
17.85,9.83,-30.33,0.989,0.108,0.008,0.105
18.14,11.67,-28.83,0.991,0.082,0.014,0.102
18.50,13.60,-27.54,0.994,0.050,0.017,0.098
18.42,15.83,-25.83,0.995,0.010,0.022,0.092
18.58,18.48,-22.71,0.995,-0.036,0.028,0.085
18.50,20.31,-19.75,0.993,-0.085,0.032,0.080
18.85,22.38,-17.00,0.988,-0.128,0.034,0.077
18.63,23.85,-15.08,0.984,-0.157,0.035,0.074
18.46,24.68,-13.46,0.981,-0.179,0.033,0.073
18.29,25.33,-11.88,0.977,-0.197,0.029,0.072
18.33,25.81,-11.46,0.976,-0.204,0.026,0.072
18.10,25.85,-11.08,0.974,-0.212,0.024,0.074
18.02,25.81,-10.63,0.973,-0.216,0.027,0.076
18.77,25.54,-10.88,0.974,-0.212,0.029,0.078
18.73,25.54,-11.33,0.976,-0.201,0.034,0.081
19.33,25.14,-11.67,0.977,-0.190,0.046,0.084
19.93,24.48,-12.33,0.979,-0.174,0.062,0.086
20.38,24.33,-12.96,0.982,-0.152,0.076,0.087
21.33,23.08,-14.38,0.983,-0.134,0.088,0.089
21.42,22.18,-15.38,0.984,-0.118,0.098,0.090
21.29,21.75,-15.96,0.985,-0.101,0.108,0.091
22.33,20.89,-16.58,0.985,-0.080,0.122,0.090
22.67,19.96,-17.71,0.985,-0.058,0.133,0.089
22.98,19.14,-19.00,0.986,-0.034,0.135,0.089
22.71,17.39,-21.13,0.987,-0.011,0.132,0.091
22.67,16.33,-22.04,0.988,0.006,0.126,0.093
22.29,16.42,-22.42,0.989,0.021,0.113,0.093
21.42,14.63,-24.21,0.990,0.042,0.097,0.093
20.77,13.81,-26.00,0.991,0.060,0.081,0.093
19.93,13.23,-26.42,0.990,0.075,0.068,0.094
19.81,12.67,-27.21,0.990,0.086,0.058,0.094
19.73,12.21,-27.67,0.990,0.096,0.047,0.094
18.25,11.35,-28.83,0.990,0.103,0.033,0.093
17.67,11.54,-28.71,0.990,0.105,0.020,0.091
17.10,11.77,-29.46,0.991,0.098,0.010,0.088
16.42,13.18,-28.58,0.994,0.078,-0.003,0.082
15.63,14.98,-27.04,0.996,0.045,-0.013,0.073
15.29,16.92,-25.21,0.998,0.006,-0.017,0.064
14.93,19.60,-23.21,0.998,-0.040,-0.021,0.053
14.38,22.14,-19.92,0.995,-0.091,-0.023,0.042
14.06,23.89,-17.00,0.989,-0.140,-0.020,0.032
13.46,26.54,-13.08,0.981,-0.192,-0.016,0.023
13.81,27.38,-9.96,0.972,-0.233,-0.008,0.017
13.58,27.92,-8.25,0.966,-0.257,0.003,0.013
13.77,28.85,-6.63,0.960,-0.278,0.017,0.012
14.85,28.68,-5.21,0.957,-0.288,0.036,0.016
15.73,28.46,-4.54,0.956,-0.288,0.054,0.021
16.50,28.42,-4.58,0.956,-0.285,0.070,0.029
17.77,27.64,-4.63,0.958,-0.269,0.088,0.040
18.93,27.02,-6.42,0.962,-0.245,0.106,0.053
20.10,25.73,-8.38,0.967,-0.214,0.121,0.067
21.38,24.43,-10.04,0.972,-0.182,0.129,0.078
22.42,23.35,-11.79,0.976,-0.151,0.133,0.087
22.89,22.23,-13.92,0.979,-0.116,0.135,0.095
23.29,20.54,-15.75,0.983,-0.079,0.134,0.100
23.63,18.96,-18.13,0.985,-0.040,0.131,0.108
23.85,17.13,-20.63,0.986,-0.005,0.123,0.115
23.10,15.60,-22.33,0.987,0.022,0.113,0.116
22.50,14.71,-23.33,0.988,0.041,0.101,0.112
22.25,14.04,-24.58,0.989,0.051,0.090,0.108
21.54,13.73,-24.79,0.990,0.054,0.079,0.105
20.54,13.88,-25.33,0.991,0.052,0.064,0.103
19.98,14.18,-25.58,0.993,0.047,0.047,0.100
19.06,14.67,-25.79,0.994,0.035,0.027,0.097
18.33,15.88,-25.17,0.996,0.018,0.006,0.093
17.14,17.23,-24.25,0.996,-0.014,-0.010,0.088
16.46,19.46,-22.67,0.995,-0.053,-0.018,0.080
16.02,22.42,-19.42,0.992,-0.098,-0.022,0.070
15.89,23.23,-18.38,0.989,-0.127,-0.027,0.065
15.33,24.06,-16.50,0.987,-0.145,-0.033,0.066
15.63,24.21,-15.88,0.985,-0.152,-0.033,0.068
15.77,24.56,-15.42,0.984,-0.161,-0.026,0.068
16.21,24.64,-14.17,0.983,-0.171,-0.013,0.069
16.50,25.27,-14.17,0.982,-0.177,0.001,0.071
17.50,24.68,-13.83,0.982,-0.174,0.021,0.074
18.98,23.67,-14.38,0.984,-0.154,0.050,0.078
20.38,22.38,-15.17,0.986,-0.125,0.077,0.084
21.14,21.06,-16.42,0.986,-0.100,0.097,0.092
22.42,19.96,-17.42,0.986,-0.075,0.112,0.097
22.89,19.14,-18.54,0.986,-0.049,0.128,0.097
23.42,18.33,-19.25,0.985,-0.026,0.138,0.097
23.71,16.96,-20.42,0.986,-0.003,0.139,0.097
23.18,16.54,-21.38,0.986,0.015,0.133,0.097
22.63,15.33,-22.46,0.988,0.026,0.123,0.095
22.10,14.43,-23.54,0.989,0.041,0.107,0.090
20.58,14.04,-25.08,0.991,0.058,0.085,0.085
19.18,13.88,-25.88,0.992,0.071,0.061,0.081
18.06,13.68,-26.67,0.993,0.078,0.040,0.079
17.06,13.29,-27.88,0.993,0.087,0.019,0.081
16.50,11.46,-29.13,0.991,0.105,0.002,0.087
16.21,10.33,-29.71,0.988,0.119,-0.011,0.093
16.06,10.02,-30.33,0.987,0.126,-0.018,0.097
16.14,9.75,-30.29,0.986,0.132,-0.012,0.098
16.81,9.43,-30.79,0.985,0.143,-0.001,0.097
17.06,8.50,-30.63,0.983,0.153,0.009,0.097
17.58,8.46,-31.17,0.983,0.152,0.012,0.099
17.67,8.54,-30.63,0.985,0.141,0.012,0.098
17.58,10.33,-30.04,0.988,0.120,0.011,0.093
17.14,11.81,-28.88,0.992,0.089,0.009,0.085
16.54,14.00,-26.92,0.996,0.044,0.006,0.078
16.25,17.04,-24.38,0.997,-0.018,-0.001,0.070
15.77,21.13,-21.13,0.994,-0.088,-0.011,0.061
15.46,23.63,-17.08,0.988,-0.144,-0.020,0.055
14.93,25.58,-13.50,0.979,-0.193,-0.028,0.054
14.81,26.71,-10.96,0.970,-0.233,-0.034,0.054
14.93,27.60,-9.50,0.967,-0.247,-0.037,0.056
15.63,27.52,-8.75,0.965,-0.253,-0.038,0.057
15.73,27.33,-8.83,0.966,-0.249,-0.035,0.060
15.85,27.38,-9.46,0.968,-0.239,-0.032,0.065
15.89,26.79,-10.29,0.971,-0.226,-0.027,0.070
16.38,26.93,-11.00,0.976,-0.203,-0.022,0.077
17.63,24.75,-13.96,0.980,-0.179,-0.015,0.084
17.98,24.02,-15.79,0.985,-0.149,-0.008,0.092
18.58,22.38,-18.33,0.989,-0.111,0.001,0.099
19.14,20.04,-20.58,0.992,-0.067,0.015,0.104
19.38,19.10,-21.88,0.993,-0.022,0.031,0.109
20.67,15.29,-24.71,0.992,0.022,0.046,0.114
21.33,12.56,-26.29,0.989,0.064,0.057,0.118
21.63,11.18,-27.25,0.987,0.089,0.067,0.119
21.98,10.56,-27.33,0.985,0.097,0.079,0.119
22.63,11.35,-26.25,0.985,0.085,0.097,0.116
23.10,12.75,-24.92,0.985,0.064,0.118,0.108
23.14,14.31,-23.13,0.985,0.041,0.136,0.099
23.67,15.17,-22.13,0.984,0.023,0.145,0.097
24.10,15.39,-21.25,0.983,0.012,0.152,0.097
23.89,16.64,-20.29,0.983,-0.003,0.157,0.095
23.58,17.67,-19.21,0.984,-0.026,0.152,0.089
22.89,19.06,-18.50,0.986,-0.047,0.139,0.084
22.10,19.85,-18.00,0.987,-0.064,0.122,0.083
21.25,20.63,-17.50,0.989,-0.071,0.101,0.085
20.54,20.48,-18.17,0.990,-0.074,0.073,0.091
19.93,20.39,-19.17,0.991,-0.078,0.043,0.099
19.33,20.63,-19.79,0.991,-0.081,0.016,0.102
18.14,20.89,-19.96,0.992,-0.071,-0.002,0.100
17.63,19.92,-21.50,0.993,-0.055,-0.014,0.101
16.89,19.14,-22.83,0.994,-0.041,-0.023,0.101
16.50,18.29,-23.79,0.994,-0.015,-0.029,0.101
16.29,16.77,-25.50,0.994,0.020,-0.028,0.102
16.77,14.81,-27.33,0.993,0.056,-0.022,0.104
16.81,12.67,-29.17,0.990,0.089,-0.015,0.105
16.81,10.38,-30.04,0.987,0.120,-0.007,0.106
16.89,8.35,-31.13,0.983,0.149,0.002,0.106
17.33,6.25,-31.83,0.977,0.185,0.013,0.109
18.29,3.04,-33.17,0.964,0.239,0.027,0.116
19.25,0.00,-33.58,0.954,0.271,0.038,0.122
19.50,-1.06,-33.08,0.955,0.267,0.048,0.120
19.73,0.52,-32.83,0.962,0.242,0.058,0.113
20.46,3.04,-31.46,0.973,0.195,0.065,0.105
20.29,7.46,-29.25,0.985,0.125,0.069,0.098
20.54,12.17,-26.33,0.991,0.052,0.073,0.096
20.98,16.46,-22.67,0.992,-0.015,0.077,0.095
20.77,18.83,-19.58,0.990,-0.075,0.076,0.094
20.81,21.13,-17.08,0.986,-0.118,0.073,0.089
19.98,23.39,-13.54,0.982,-0.156,0.072,0.084
19.63,24.52,-11.50,0.977,-0.185,0.069,0.080
19.10,25.38,-10.04,0.974,-0.204,0.063,0.076
18.67,26.08,-9.46,0.972,-0.219,0.053,0.072
18.14,25.85,-9.67,0.971,-0.222,0.043,0.071
18.42,25.58,-9.71,0.973,-0.215,0.035,0.074
17.98,25.10,-11.75,0.977,-0.198,0.022,0.077
17.38,24.79,-14.33,0.983,-0.168,0.001,0.081
17.02,23.17,-17.04,0.988,-0.130,-0.016,0.088
16.93,21.33,-20.75,0.992,-0.086,-0.022,0.093
17.06,19.14,-23.04,0.994,-0.040,-0.025,0.098
16.68,16.85,-25.46,0.994,0.003,-0.027,0.106
17.14,14.93,-27.25,0.993,0.034,-0.026,0.113
17.98,13.46,-27.79,0.992,0.054,-0.014,0.115
18.14,12.52,-28.33,0.991,0.070,0.001,0.115
18.58,11.23,-28.71,0.989,0.090,0.015,0.116
19.50,9.92,-29.17,0.986,0.109,0.034,0.118
20.81,9.29,-28.58,0.985,0.114,0.056,0.119
22.29,10.14,-27.17,0.984,0.103,0.087,0.115
23.10,12.13,-25.50,0.985,0.076,0.116,0.107
23.54,13.50,-23.54,0.985,0.047,0.135,0.100
23.89,14.81,-22.38,0.983,0.025,0.153,0.098
24.23,16.18,-20.79,0.981,0.009,0.167,0.098
24.29,16.46,-19.79,0.981,-0.007,0.170,0.098
23.81,17.63,-18.79,0.982,-0.023,0.163,0.094
23.14,18.21,-18.33,0.984,-0.040,0.148,0.087
22.02,19.60,-18.08,0.987,-0.052,0.130,0.084
21.33,19.60,-18.58,0.989,-0.049,0.112,0.085
20.67,19.50,-19.75,0.992,-0.034,0.084,0.086
19.10,18.79,-21.79,0.995,-0.020,0.049,0.089
18.50,18.29,-22.63,0.996,-0.009,0.021,0.091
17.50,17.67,-23.83,0.996,0.006,0.003,0.091
16.73,16.33,-25.21,0.995,0.029,-0.011,0.093
16.33,15.13,-27.04,0.993,0.058,-0.019,0.098
16.38,13.42,-28.42,0.991,0.082,-0.023,0.101
16.33,11.71,-29.29,0.989,0.102,-0.022,0.104
16.77,10.46,-29.71,0.986,0.122,-0.015,0.110
17.29,9.25,-30.54,0.983,0.140,-0.010,0.116
17.06,8.58,-31.08,0.982,0.147,-0.011,0.118
17.02,8.08,-31.04,0.982,0.151,-0.011,0.117
17.02,8.58,-30.92,0.983,0.141,-0.011,0.116
16.42,9.60,-30.29,0.987,0.115,-0.017,0.108
15.73,11.85,-28.88,0.992,0.082,-0.024,0.095
14.68,15.71,-26.92,0.995,0.039,-0.033,0.083
14.02,18.48,-24.13,0.996,-0.008,-0.042,0.072
13.73,20.75,-21.63,0.995,-0.056,-0.047,0.061
13.42,22.02,-20.13,0.992,-0.106,-0.049,0.045
12.10,25.14,-16.25,0.988,-0.143,-0.050,0.032
12.10,25.85,-14.83,0.985,-0.165,-0.051,0.030
12.81,26.04,-14.38,0.983,-0.172,-0.049,0.032
12.64,26.00,-14.00,0.982,-0.180,-0.045,0.034
13.46,26.58,-13.33,0.981,-0.185,-0.036,0.037
14.63,26.08,-13.33,0.983,-0.178,-0.018,0.045
15.85,24.88,-15.17,0.987,-0.151,0.002,0.053
17.06,23.54,-16.42,0.990,-0.122,0.022,0.063
17.73,22.10,-17.50,0.992,-0.098,0.040,0.070
18.54,20.89,-18.96,0.993,-0.070,0.060,0.071
19.14,20.13,-19.75,0.993,-0.043,0.080,0.069
19.50,18.56,-21.38,0.993,-0.014,0.094,0.072
20.33,17.00,-22.67,0.992,0.014,0.100,0.079
20.81,15.88,-23.54,0.990,0.035,0.102,0.086
21.02,14.93,-24.17,0.990,0.045,0.100,0.091
20.54,14.43,-24.63,0.990,0.053,0.093,0.095
20.42,13.60,-25.25,0.989,0.065,0.083,0.103
20.58,12.60,-26.42,0.988,0.079,0.067,0.114
20.14,11.35,-27.50,0.987,0.095,0.046,0.119
19.25,10.81,-28.46,0.987,0.103,0.027,0.121
18.77,10.73,-29.00,0.986,0.106,0.011,0.126
18.06,10.60,-29.21,0.986,0.103,-0.006,0.130
17.63,11.04,-29.17,0.987,0.093,-0.026,0.130
16.50,12.13,-28.92,0.987,0.080,-0.045,0.129
15.54,12.79,-28.54,0.988,0.068,-0.056,0.127
15.50,13.29,-28.38,0.989,0.057,-0.061,0.126
15.46,13.60,-28.04,0.990,0.047,-0.064,0.120
14.63,14.89,-27.67,0.991,0.035,-0.063,0.110
14.81,15.71,-26.88,0.993,0.023,-0.058,0.100
14.17,16.68,-26.42,0.995,0.010,-0.054,0.087
13.93,17.35,-25.21,0.996,0.000,-0.049,0.077
13.85,18.02,-25.33,0.997,-0.007,-0.037,0.065
14.29,18.64,-24.67,0.999,-0.007,-0.015,0.048
14.29,18.92,-24.21,0.999,-0.016,0.010,0.029
14.10,19.85,-22.33,0.999,-0.028,0.032,0.016
14.21,20.67,-21.79,0.998,-0.038,0.051,0.007
14.68,21.21,-20.63,0.996,-0.054,0.070,0.002
15.50,22.06,-19.33,0.994,-0.066,0.085,0.003
15.98,22.50,-18.25,0.993,-0.076,0.096,0.007
17.10,22.10,-17.79,0.991,-0.075,0.105,0.016
18.73,20.48,-18.67,0.991,-0.058,0.115,0.031
19.14,20.43,-19.42,0.991,-0.040,0.121,0.048
20.81,18.64,-19.96,0.991,-0.022,0.119,0.063
21.10,16.85,-21.83,0.990,0.002,0.117,0.077
21.71,15.64,-23.13,0.989,0.030,0.114,0.088
22.14,13.23,-25.21,0.987,0.068,0.108,0.101
21.93,11.77,-26.13,0.984,0.102,0.101,0.109
21.77,10.33,-27.38,0.983,0.115,0.094,0.111
21.54,9.92,-27.50,0.982,0.122,0.088,0.110
21.18,9.25,-28.21,0.982,0.127,0.083,0.110
20.85,9.48,-28.25,0.983,0.128,0.076,0.108
20.18,9.29,-28.75,0.983,0.134,0.068,0.106
19.77,8.67,-29.42,0.983,0.142,0.058,0.104
18.54,8.71,-29.67,0.984,0.142,0.043,0.100
17.46,9.56,-29.33,0.987,0.127,0.030,0.093
16.98,11.58,-28.83,0.991,0.098,0.019,0.087
15.93,13.77,-27.42,0.994,0.066,0.002,0.082
15.54,15.08,-26.46,0.996,0.035,-0.014,0.077
14.81,17.39,-25.17,0.997,-0.002,-0.022,0.070
14.02,19.77,-23.33,0.997,-0.038,-0.028,0.063
13.77,21.33,-21.04,0.995,-0.076,-0.030,0.056
13.73,23.27,-18.54,0.992,-0.111,-0.030,0.049
13.81,24.33,-17.08,0.989,-0.136,-0.030,0.047
13.85,25.14,-16.00,0.988,-0.148,-0.026,0.047
14.85,24.52,-15.42,0.988,-0.149,-0.017,0.049
14.85,24.33,-15.54,0.989,-0.138,-0.007,0.053
15.46,23.31,-17.25,0.992,-0.110,0.007,0.057
15.93,22.02,-18.79,0.995,-0.079,0.025,0.062
15.85,21.43,-20.33,0.996,-0.058,0.031,0.064
16.73,19.96,-21.25,0.997,-0.031,0.032,0.066
16.93,18.39,-22.71,0.997,-0.005,0.037,0.069
17.21,17.00,-23.71,0.996,0.017,0.042,0.072
17.50,16.33,-23.92,0.996,0.029,0.045,0.075
17.73,15.71,-24.83,0.995,0.041,0.048,0.076
18.06,15.64,-24.96,0.995,0.043,0.051,0.076
17.63,15.71,-24.92,0.995,0.041,0.051,0.075
17.81,15.88,-24.67,0.995,0.038,0.051,0.075
17.67,15.96,-24.54,0.995,0.036,0.052,0.074
17.46,15.71,-24.46,0.995,0.035,0.052,0.075
17.81,15.88,-24.67,0.995,0.034,0.052,0.075
17.98,15.96,-24.71,0.995,0.034,0.052,0.076
17.89,16.18,-24.33,0.995,0.031,0.053,0.075
17.67,16.33,-24.04,0.995,0.030,0.052,0.075
17.54,16.29,-24.29,0.995,0.030,0.053,0.076
17.98,16.42,-24.33,0.995,0.029,0.053,0.076
18.14,16.64,-23.96,0.995,0.028,0.053,0.076
18.63,16.46,-23.71,0.995,0.027,0.054,0.076
18.02,16.73,-23.63,0.995,0.026,0.054,0.076
18.10,16.42,-23.58,0.995,0.023,0.054,0.075
18.06,16.73,-23.08,0.996,0.020,0.055,0.074
17.93,16.68,-22.83,0.996,0.016,0.055,0.073
17.58,17.85,-22.92,0.996,0.010,0.055,0.071
    ];


magnetometer_data = raw_data(:,1:3); % uT
%gyroscope_data = raw_data(:,4:6)*R2D; % dps
att_q = raw_data(:, 4:7);

% 设置数据比例
data_ratio = 1/3;

% 选择连续的数据段用于校准
total_samples = size(magnetometer_data, 1);
calibration_samples = round(total_samples * data_ratio);
start_index = randi(total_samples - calibration_samples + 1);
end_index = start_index + calibration_samples - 1;

mag_calibration_subset = magnetometer_data(start_index:end_index, :);
att_q_calibration_subset = att_q(start_index:end_index, :);



%% 椭球拟合法 (magcal)
[calibration_matrix, hard_iron_bias, expected_field_strength] = magcal(mag_calibration_subset, 'auto');

% 显示校准结果
fprintf('magcal 校准结果:\n');
fprintf('校准矩阵:\n');
disp(calibration_matrix);
fprintf('硬铁干扰 (偏置): [%.3f, %.3f, %.3f]\n', hard_iron_bias);
fprintf('预期磁场强度: %.3f\n', expected_field_strength);

% 应用校准
mag_calibrated_magcal = (mag_calibration_subset - hard_iron_bias) * calibration_matrix;

[kf_hard_iron_bias, kf_state_history, kf_covariance_history] = kalman_filter_magnetometer_calibration(mag_calibration_subset, att_q_calibration_subset);

fprintf('\n卡尔曼滤波法校准结果:\n');
fprintf('硬铁干扰 (偏置): [%.3f, %.3f, %.3f]\n', kf_hard_iron_bias);

% 应用卡尔曼滤波校准
mag_calibrated_kf = mag_calibration_subset - kf_hard_iron_bias';

%% 绘图比较

% 2D 比较图
figure('Name', '2D Comparisons');

subplot(2, 2, 1);
plot_2d_comparison(mag_calibration_subset, mag_calibrated_magcal, mag_calibrated_kf, 1, 2, 'X', 'Y');

subplot(2, 2, 2);
plot_2d_comparison(mag_calibration_subset, mag_calibrated_magcal, mag_calibrated_kf, 1, 3, 'X', 'Z');

subplot(2, 2, 3);
plot_2d_comparison(mag_calibration_subset, mag_calibrated_magcal, mag_calibrated_kf, 2, 3, 'Y', 'Z');

sgtitle('2D Comparisons of Magnetometer Calibration', 'FontSize', 16, 'FontWeight', 'bold');

% 绘制卡尔曼滤波收敛过程和硬磁估计
figure('Name', 'Kalman Filter Convergence and Hard Iron Estimation');

subplot(2, 1, 1);
plot(kf_covariance_history);
title('Kalman Filter Trace of P Matrix');
xlabel('Iteration');
ylabel('Trace(P)');

subplot(2, 1, 2);
plot(kf_state_history(:, 4:6), '.-');
title('Kalman Filter Hard Iron Estimation');
xlabel('Iteration');
ylabel('Hard Iron (uT)');
legend('X', 'Y', 'Z');

% 3D 比较图
figure('Name', '3D Comparison');
plot_3d_comparison(mag_calibration_subset, mag_calibrated_magcal, calibration_matrix, hard_iron_bias, expected_field_strength);

%% 评估指标（使用全部数据集）

% 应用校准到全部数据集
mag_calibrated_magcal_full = (magnetometer_data - hard_iron_bias) * calibration_matrix;
mag_calibrated_kf_full = magnetometer_data - kf_hard_iron_bias';

% 计算磁场模
mag_uncalibrated_magnitude = sqrt(sum(magnetometer_data.^2, 2));
mag_calibrated_magcal_magnitude = sqrt(sum(mag_calibrated_magcal_full.^2, 2));
mag_calibrated_kf_magnitude = sqrt(sum(mag_calibrated_kf_full.^2, 2));

% 计算标准差
std_uncalibrated = std(mag_uncalibrated_magnitude);
std_magcal = std(mag_calibrated_magcal_magnitude);
std_kf = std(mag_calibrated_kf_magnitude);

% 计算改善百分比
improvement_magcal = (std_uncalibrated - std_magcal) / std_uncalibrated * 100;
improvement_kf = (std_uncalibrated - std_kf) / std_uncalibrated * 100;

% 打印结果
fprintf('Samples: %d,%d (%.1f%%)\n', total_samples, calibration_samples, data_ratio * 100);
fprintf('Method      Std Dev    Improvement\n');
fprintf('-------------------------------------\n');
fprintf('Uncalibrated %.4f    -\n', std_uncalibrated);
fprintf('Magcal       %.4f    %.2f%%\n', std_magcal, improvement_magcal);
fprintf('Kalman       %.4f    %.2f%%\n', std_kf, improvement_kf);

%% Helper functions
function plot_3d_comparison(uncalibrated, calibrated_magcal, calibration_matrix, hard_iron_bias, expected_field_strength)
    % 创建图形并设置属性
    ax = gca; % 获取当前坐标轴
    hold(ax, 'on');
    
    % 绘制未校准数据
    scatter3(ax, uncalibrated(:,1), uncalibrated(:,2), uncalibrated(:,3), ...
        10, [0.7 0.7 0.7], 'filled', 'MarkerEdgeColor', 'none', 'MarkerFaceAlpha', 0.5);
    
    % 绘制magcal校准后的数据
    scatter3(ax, calibrated_magcal(:,1), calibrated_magcal(:,2), calibrated_magcal(:,3), ...
        10, 'r', 'filled', 'MarkerEdgeColor', 'none', 'MarkerFaceAlpha', 0.5);
    
    % 绘制拟合的椭球（半透明网格图）
    [x, y, z] = ellipsoid(0, 0, 0, 1, 1, 1, 20);
    x = x .* (expected_field_strength / sqrt(calibration_matrix(1,1))) + hard_iron_bias(1);
    y = y .* (expected_field_strength / sqrt(calibration_matrix(2,2))) + hard_iron_bias(2);
    z = z .* (expected_field_strength / sqrt(calibration_matrix(3,3))) + hard_iron_bias(3);
    ellipsoid_surface = mesh(ax, x, y, z, 'EdgeColor', [0.3 0.3 1], 'FaceAlpha', 0, 'EdgeAlpha', 0.3);
    
    % 绘制校正后的球体（半透明网格图）
    [x, y, z] = sphere(20);
    x = x * expected_field_strength; y = y * expected_field_strength; z = z * expected_field_strength;
    sphere_surface = mesh(ax, x, y, z, 'EdgeColor', [1 0.3 0.3], 'FaceAlpha', 0, 'EdgeAlpha', 0.3);
    
    % 设置光照以增强3D效果
    light('Position', [1 1 1], 'Style', 'infinite');
    lighting gouraud
    
    % 设置图形属性
    grid(ax, 'on');
    axis(ax, 'equal');
    xlabel(ax, 'X (uT)', 'FontWeight', 'bold');
    ylabel(ax, 'Y (uT)', 'FontWeight', 'bold');
    zlabel(ax, 'Z (uT)', 'FontWeight', 'bold');
    title(ax, "Uncalibrated vs Calibrated Magnetometer Measurements (magcal)", 'FontWeight', 'bold');
    
    % 添加图例
    legend(ax, 'Uncalibrated', 'Calibrated (magcal)', 'Fitted Ellipsoid', 'Corrected Sphere', ...
        'Location', 'southoutside', 'Orientation', 'horizontal');
    
    % 设置视角
    view(ax, 3);
    
    % 添加旋转控制
    rotate3d(ax, 'on');
    
    hold(ax, 'off');
end





function plot_2d_comparison(uncalibrated, calibrated_magcal, calibrated_kf, x_index, y_index, x_label, y_label)
plot(uncalibrated(:,x_index), uncalibrated(:,y_index), ...
    'LineStyle', 'none', 'Marker', '.', 'MarkerSize', 5, 'Color', [0.5 0.5 0.5]);
hold on;
plot(calibrated_magcal(:,x_index), calibrated_magcal(:,y_index), ...
    'LineStyle', 'none', 'Marker', '.', 'MarkerSize', 5, 'Color', 'r');
plot(calibrated_kf(:,x_index), calibrated_kf(:,y_index), ...
    'LineStyle', 'none', 'Marker', '.', 'MarkerSize', 5, 'Color', 'g');
grid on;
axis equal;
xlabel([x_label ' (uT)'], 'FontSize', 12);
ylabel([y_label ' (uT)'], 'FontSize', 12);
legend('Uncalibrated', 'magcal', 'Kalman Filter', 'Location', 'best', 'FontSize', 10);
title(['Plane ' x_label '-' y_label], 'FontSize', 14, 'FontWeight', 'bold');
hold off;
end

% Real-Time Magnetic Field Calibration Method Based on Extended Kalman Filter
function [hard_iron_bias, state_history, covariance_history] = kalman_filter_magnetometer_calibration(magnetometer_data, att_q, sampling_interval)
% 初始化状态向量
X = zeros(6,1);
X(1:3) = magnetometer_data(1,:)'; % 初始磁场估计
X(4:6) = [0; 0; 0];     % 初始硬铁偏置估计

% 初始化协方差矩阵
P = diag([0.2, 0.2, 0.2, 10, 10, 10]);

% 过程噪声协方差矩阵
process_noise = diag([0, 0, 0, 0, 0, 0]);

% 测量噪声协方差矩阵0
R = diag([1, 1, 1])*0.001;

data_length = size(magnetometer_data, 1);
state_history = zeros(data_length, 6);
covariance_history = zeros(data_length, 1);

for i = 1:data_length
    Z = magnetometer_data(i,:)';

    % 计算状态转移矩阵
    if i > 1
        Q_prev_b2n = att_q(i-1, :)';
        Qb2n = att_q(i, :)';
        
        % 计算从上一时刻到当前时刻的旋转矩阵
        
        Qb2b_prev= ch_qmul(ch_qconj(Q_prev_b2n), Qb2n);
        Rb2b_prev = ch_q2m(Qb2b_prev)';
        
        % 构建完整的6x6状态转移矩阵
        F = [Rb2b_prev, zeros(3,3); 
            zeros(3,3), eye(3)];
    else
        F = eye(6);
    end

    % 预测步骤
    X = F * X;
    P = F * P * F' + process_noise;

    % 更新步骤
    H = [eye(3), eye(3)];

    innovation = Z - H * X;
    innovation_covariance = H * P * H' + R;
    K = P * H' / innovation_covariance;

    X = X + K * innovation;
    P = (eye(6) - K * H) * P;

    % 存储结果
    state_history(i,:) = X';
    covariance_history(i) = trace(P);
end

hard_iron_bias = X(4:6); % 最终估计的硬铁偏置
end

