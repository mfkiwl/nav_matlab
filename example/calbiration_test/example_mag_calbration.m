close all;
clear;
clc;
format short;

%% 加载数据
% fullfilename  = "./mag_test.csv";
%
% T = readtable(fullfilename); % 读取 CSV 文件
% frame_name = table2cell(T(:,1));

% gyr = [T.gyr_x T.gyr_y T.gyr_z];
% mag = [T.mag_x T.mag_y T.mag_z];

raw_data  = [
36.46,-28.38, -53.17, -0.05, -0.04, -0.08
36.35,-27.75, -52.50, -0.01, 0.03, -0.12
36.79,-27.96, -52.75, -0.08, 0.03, -0.14
36.88,-27.96, -53.21, -0.09, 0.00, -0.15
36.50,-27.88, -53.04, -0.15, -0.02, -0.14
36.67,-27.33, -53.29, -0.02, -0.03, -0.06
36.93,-27.79, -52.96, 0.07, 0.03, 0.06
36.18,-27.56, -53.21, 0.07, -0.02, 0.07
36.71,-27.38, -53.04, -0.00, -0.12, 0.02
36.42,-28.06, -53.33, 0.06, -0.09, -0.00
36.93,-27.88, -52.92, 0.01, -0.02, -0.03
36.58,-27.83, -53.21, -0.04, 0.01, -0.05
36.27,-27.38, -53.67, -0.03, -0.01, -0.07
36.54,-27.64, -53.63, -0.02, -0.02, -0.10
36.35,-27.64, -53.21, -0.01, 0.02, -0.09
36.79,-27.29, -53.21, 0.02, 0.05, -0.07
36.23,-27.17, -53.08, -0.02, 0.01, -0.07
36.42,-27.64, -52.75, -0.01, 0.06, -0.08
36.58,-27.48, -53.13, -0.04, 0.06, -0.05
36.63,-27.56, -52.96, -0.01, 0.02, -0.05
36.63,-27.21, -52.96, -0.04, -0.04, -0.04
36.50,-27.33, -53.04, 0.05, -0.02, -0.05
36.75,-27.33, -53.25, 0.02, -0.05, -0.09
36.93,-27.25, -53.63, 0.05, -0.04, -0.12
37.02,-27.60, -53.54, -0.04, -0.03, -0.13
36.63,-27.38, -53.25, 0.01, -0.01, -0.15
36.54,-26.89, -53.33, -0.01, 0.00, -0.18
36.98,-27.02, -53.21, 0.04, 0.03, -0.26
37.14,-27.06, -53.42, -0.02, -0.04, -0.41
37.02,-26.79, -53.29, -0.10, -0.25, -0.60
36.88,-26.04, -53.50, -0.12, -0.17, -0.80
37.10,-25.64, -53.71, -0.30, -0.14, -0.96
37.18,-24.48, -53.71, -0.21, -0.30, -0.78
37.23,-23.98, -54.00, -0.10, -0.14, -0.55
37.27,-23.67, -54.00, -0.01, 0.04, -0.39
37.63,-23.23, -54.04, 0.04, 0.03, -0.28
37.63,-23.48, -53.75, -0.01, -0.04, -0.29
38.10,-23.04, -54.33, -0.18, -0.18, -0.35
37.50,-22.85, -53.83, -0.19, -0.16, -0.41
37.58,-22.33, -54.33, -0.19, -0.13, -0.37
37.54,-21.83, -54.17, -0.18, -0.12, -0.23
37.67,-22.14, -54.58, -0.03, -0.06, -0.02
37.54,-22.23, -54.17, 0.18, 0.11, 0.04
37.79,-22.10, -54.13, 0.06, 0.05, 0.09
37.46,-22.54, -54.25, -0.10, -0.02, 0.17
37.88,-22.68, -54.13, -0.03, 0.03, 0.20
37.67,-22.18, -54.25, 0.09, 0.01, 0.14
37.23,-22.42, -54.33, -0.04, -0.11, 0.16
37.39,-22.81, -54.08, -0.01, -0.08, 0.20
37.63,-22.50, -54.17, 0.17, 0.12, 0.36
37.58,-22.96, -54.29, 0.27, 0.16, 0.42
37.54,-23.39, -53.96, 0.19, 0.09, 0.32
37.67,-23.58, -54.04, -0.19, -0.03, 0.21
37.54,-23.58, -54.13, -0.22, -0.12, 0.27
37.27,-23.93, -54.08, 0.05, -0.15, 0.45
36.83,-23.98, -54.17, 0.21, -0.28, 0.47
36.42,-24.17, -54.21, 0.00, -0.17, 0.46
36.02,-24.75, -54.54, 0.06, -0.27, 0.42
36.14,-24.75, -54.38, -0.24, -0.28, 0.38
35.50,-24.60, -54.42, -0.04, -0.11, 0.23
35.88,-24.92, -54.38, 0.01, 0.13, 0.26
35.79,-24.56, -54.46, 0.01, 0.11, 0.30
35.83,-24.92, -54.38, 0.00, 0.21, 0.23
36.10,-25.10, -54.29, -0.15, 0.09, 0.16
35.83,-24.88, -54.46, -0.27, -0.02, 0.09
35.88,-24.43, -55.00, -0.42, -0.02, 0.14
35.98,-24.17, -55.08, -0.46, 0.06, 0.09
36.18,-24.06, -54.96, -0.47, -0.11, -0.05
35.79,-22.77, -55.13, -0.45, -0.22, -0.08
35.83,-22.73, -55.83, -0.04, 0.04, -0.02
35.93,-22.81, -55.17, 0.03, 0.16, 0.02
36.46,-22.77, -55.00, -0.14, 0.03, -0.05
36.02,-22.58, -55.33, 0.09, 0.06, -0.07
36.50,-23.31, -55.00, -0.04, 0.12, -0.02
36.58,-22.92, -55.33, -0.03, 0.13, -0.01
36.42,-22.73, -55.42, 0.17, 0.22, 0.05
37.27,-23.08, -55.17, 0.10, 0.24, 0.13
37.46,-23.48, -54.83, 0.05, 0.03, 0.04
37.23,-23.48, -55.33, -0.02, -0.07, 0.03
37.02,-23.00, -55.50, -0.13, -0.09, -0.01
37.50,-23.17, -54.92, -0.24, -0.04, -0.07
37.27,-23.04, -55.54, -0.67, -0.51, 0.09
36.58,-22.38, -55.79, -0.20, -0.76, 0.15
35.98,-22.50, -55.92, 0.45, -0.38, 0.23
36.06,-22.73, -56.00, 0.31, -0.01, 0.18
35.31,-23.13, -56.29, -0.01, -0.20, 0.27
35.31,-23.00, -56.29, -0.34, -0.01, 0.41
35.42,-23.04, -56.33, 0.02, 0.05, 0.46
35.46,-22.85, -55.79, -0.03, 0.04, 0.80
35.06,-23.39, -56.00, -0.14, 0.24, 1.09
35.02,-24.06, -56.08, -0.05, 0.21, 0.75
35.23,-24.38, -56.00, -0.23, 0.08, 0.54
35.46,-23.98, -56.25, -0.54, 0.18, 0.61
35.02,-23.98, -56.17, -0.49, 0.37, 0.46
35.71,-23.17, -56.08, -0.40, 0.32, 0.16
36.14,-23.04, -56.17, -0.40, 0.01, 0.34
35.31,-23.00, -56.00, 0.11, -0.60, 0.79
34.50,-23.75, -56.46, 0.34, -0.90, 0.99
33.38,-24.43, -56.75, 0.29, -0.61, 0.86
32.42,-24.96, -56.58, 0.31, 0.06, 0.68
32.79,-25.27, -56.50, 0.20, 0.12, 0.63
32.93,-25.85, -56.46, 0.01, 0.19, 0.80
32.79,-26.08, -56.17, 0.03, 0.27, 0.89
32.75,-27.02, -56.08, 0.16, 0.27, 0.92
32.89,-27.25, -56.00, 0.22, 0.20, 0.77
32.93,-27.88, -55.71, 0.10, 0.29, 0.92
32.93,-28.54, -55.88, 0.08, 0.24, 0.96
32.89,-28.73, -55.67, 0.00, 0.23, 0.88
32.75,-29.00, -55.46, -0.08, 0.25, 1.04
32.75,-29.58, -55.42, -0.05, 0.30, 1.03
32.75,-29.67, -55.04, 0.04, 0.16, 0.61
32.75,-30.48, -55.46, -0.05, 0.12, 0.72
32.18,-30.29, -54.83, -0.01, 0.01, 0.78
32.38,-30.56, -55.00, 0.01, -0.04, 0.82
31.63,-30.96, -55.42, -0.04, 0.09, 0.79
31.71,-31.46, -55.46, 0.04, 0.21, 0.89
31.67,-31.31, -54.92, 0.11, 0.24, 0.82
31.38,-31.85, -54.50, 0.19, 0.24, 0.69
31.58,-32.31, -54.75, 0.07, 0.12, 0.87
31.02,-32.89, -54.88, -0.01, 0.01, 0.78
30.89,-33.21, -54.42, -0.08, 0.13, 0.76
31.18,-33.06, -54.75, -0.04, 0.16, 0.64
31.06,-33.79, -54.63, -0.03, 0.15, 0.59
30.67,-33.60, -54.71, -0.12, 0.00, 0.82
29.75,-33.79, -55.08, -0.22, -0.18, 1.17
29.18,-33.56, -55.04, -0.30, -0.14, 1.17
29.06,-33.83, -55.08, -0.40, -0.16, 0.88
28.75,-33.56, -55.50, -0.38, -0.20, 0.54
27.71,-33.38, -55.63, -0.30, -0.12, 0.48
27.89,-33.29, -55.92, -0.40, -0.03, 0.65
27.38,-32.98, -56.00, -0.29, 0.05, 0.53
27.71,-33.10, -56.42, -0.35, -0.02, 0.65
26.98,-33.10, -56.29, -0.40, -0.12, 0.70
26.89,-32.43, -56.46, -0.38, -0.09, 0.81
26.10,-32.35, -56.71, -0.30, -0.28, 0.62
25.46,-32.13, -56.92, -0.20, -0.17, 0.44
25.02,-32.31, -56.88, -0.09, -0.21, 0.47
24.71,-32.27, -57.21, -0.08, -0.13, 0.46
24.67,-32.31, -57.38, -0.03, 0.01, 0.44
24.33,-32.00, -57.54, -0.06, 0.09, 0.56
24.14,-32.58, -57.50, -0.07, 0.02, 0.66
23.81,-32.67, -57.08, 0.08, 0.07, 0.37
23.63,-32.67, -57.00, 0.08, 0.24, 0.25
24.06,-32.52, -56.96, -0.16, 0.25, 0.28
24.38,-32.35, -57.08, -0.05, 0.27, 0.45
24.38,-32.52, -57.38, 0.02, 0.07, 0.53
23.98,-32.67, -57.04, 0.03, -0.02, 0.61
23.93,-32.98, -57.25, 0.03, -0.10, 0.74
23.06,-33.33, -57.04, -0.10, -0.03, 0.91
22.38,-33.33, -56.92, -0.15, 0.11, 0.83
22.85,-33.10, -57.38, -0.14, 0.15, 0.89
23.02,-33.60, -57.08, 0.12, 0.34, 0.70
22.54,-33.96, -56.96, 0.10, 0.16, 0.56
22.42,-34.00, -56.83, 0.10, 0.09, 0.44
22.25,-34.00, -56.83, 0.07, 0.04, 0.43
21.98,-34.31, -56.75, 0.01, -0.06, 0.68
21.63,-34.31, -56.88, 0.07, -0.17, 0.41
21.42,-34.42, -57.04, 0.10, -0.15, 0.18
21.06,-34.93, -56.58, 0.21, -0.21, 0.29
20.89,-35.04, -56.54, 0.29, -0.20, 0.57
19.67,-35.71, -56.42, 0.70, -0.65, 0.80
18.63,-36.60, -56.46, 0.35, -0.48, 0.58
18.58,-36.79, -56.04, 0.33, -0.51, 0.41
17.29,-36.96, -55.71, 0.49, -0.52, 0.79
16.38,-37.93, -55.58, 0.59, -0.57, 1.11
15.29,-38.56, -55.29, 0.60, -0.71, 1.08
13.81,-39.38, -55.04, 0.47, -0.86, 0.74
12.73,-39.33, -54.88, -0.01, -0.16, 0.49
12.54,-39.38, -55.00, -0.32, 0.04, 0.11
12.46,-38.88, -55.33, -0.28, 0.25, 0.52
12.06,-38.71, -55.29, -0.13, 0.28, 1.19
11.81,-38.75, -55.13, -0.16, 0.47, 1.34
12.25,-38.75, -55.25, -0.34, 0.43, 1.27
12.02,-37.85, -55.33, -0.58, 0.77, 0.73
12.02,-37.31, -56.08, -0.34, 0.65, 0.97
12.29,-37.67, -56.25, 0.01, 0.11, 1.60
11.33,-37.73, -55.96, -0.02, -0.04, 1.79
10.38,-36.79, -56.13, -0.05, 0.18, 1.41
10.06,-36.56, -56.00, -0.02, 0.39, 1.60
9.17,-36.79, -56.08, 0.08, 0.32, 1.96
9.02,-36.52, -56.21, 0.41, -0.07, 1.78
7.81,-37.18, -55.92, 0.56, -0.67, 1.96
5.77,-37.42, -55.79, 0.54, -0.81, 2.27
4.08,-37.18, -55.21, 0.32, -0.50, 2.36
2.33,-37.10, -54.50, 0.04, 0.21, 1.86
1.25,-36.52, -54.79, 0.06, 0.42, 2.00
0.73,-36.52, -54.67, 0.13, 0.13, 2.31
-0.17,-36.10, -54.54, -0.03, -0.18, 1.80
-1.52,-35.63, -54.54, -0.06, 0.01, 1.48
-1.77,-34.93, -54.46, -0.01, 0.22, 1.50
-3.04,-34.27, -54.38, 0.05, 0.27, 1.47
-2.73,-34.38, -54.75, 0.01, 0.45, 1.67
-4.02,-32.63, -54.63, 0.03, 0.10, 1.67
-4.38,-32.89, -54.75, 0.00, 0.44, 1.29
-4.64,-32.27, -54.83, -0.13, 0.44, 1.18
-4.56,-31.50, -55.33, -0.26, 0.22, 1.28
-5.50,-31.14, -55.67, -0.35, 0.01, 1.64
-5.89,-30.48, -55.75, -0.37, -0.13, 1.93
-6.98,-28.73, -55.58, -0.24, -0.01, 1.83
-7.13,-28.46, -55.71, -0.06, 0.31, 1.06
-7.60,-27.75, -56.08, -0.12, 0.26, 0.68
-7.25,-27.25, -55.96, -0.19, 0.07, 1.14
-7.98,-26.43, -56.04, -0.22, -0.41, 1.82
-9.21,-25.33, -56.08, -0.35, -0.40, 1.98
-9.89,-23.89, -56.21, -0.24, -0.24, 1.28
-10.25,-23.63, -55.71, -0.14, -0.12, 1.05
-11.02,-23.13, -55.67, -0.02, -0.26, 1.27
-12.06,-22.68, -55.79, -0.13, -0.46, 2.00
-12.98,-21.06, -55.42, -0.20, -0.70, 2.31
-13.98,-19.96, -55.33, 0.01, -0.45, 1.74
-14.33,-19.42, -54.88, 0.18, -0.11, 1.26
-15.02,-18.43, -54.71, 0.16, -0.17, 1.33
-15.50,-17.75, -54.63, 0.04, -0.28, 1.75
-16.21,-16.92, -54.33, -0.19, -0.42, 2.15
-16.89,-15.83, -54.58, -0.09, -0.47, 2.36
-17.50,-14.39, -54.13, 0.06, -0.12, 1.67
-17.89,-13.50, -54.08, 0.13, -0.02, 1.43
-17.93,-13.18, -54.17, 0.01, -0.11, 1.91
-18.29,-11.46, -53.79, -0.01, -0.07, 2.00
-18.38,-10.38, -53.54, 0.08, 0.02, 2.08
-18.50,-8.93, -53.67, 0.13, 0.25, 1.82
-18.33,-8.46, -53.88, 0.23, 0.35, 1.12
-17.50,-8.27, -54.17, 0.33, 0.54, 0.88
-16.93,-7.50, -54.63, 0.25, 0.56, 1.22
-15.93,-6.56, -54.92, 0.11, 0.55, 1.78
-15.29,-5.46, -55.38, 0.21, 0.50, 1.51
-14.29,-4.88, -56.00, 0.20, 0.43, 1.04
-14.02,-5.00, -56.08, 0.18, 0.24, 0.91
-13.89,-4.38, -56.17, 0.05, 0.25, 1.08
-13.63,-3.71, -55.83, -0.12, 0.05, 1.39
-12.81,-2.58, -56.13, -0.04, 0.02, 1.55
-12.54,-2.04, -56.17, -0.01, 0.07, 1.21
-12.85,-1.33, -56.46, -0.04, -0.05, 1.10
-12.29,-0.43, -56.25, -0.06, -0.10, 1.28
-12.77,-0.21, -56.42, -0.16, -0.08, 1.68
-12.38,1.10, -56.38, -0.24, -0.21, 1.87
-12.06,2.42, -55.92, -0.19, -0.22, 1.82
-11.33,2.98, -56.00, -0.19, -0.23, 1.54
-11.17,3.98, -55.71, -0.13, -0.17, 1.49
-11.13,5.08, -55.33, -0.15, -0.32, 1.71
-10.77,5.73, -54.92, -0.19, -0.29, 1.60
-10.64,6.75, -55.33, -0.16, -0.15, 2.01
-10.02,7.92, -54.79, -0.20, -0.12, 2.19
-9.21,9.02, -54.88, -0.43, -0.06, 2.36
-8.33,10.81, -54.92, -0.42, 0.10, 1.77
-7.64,11.50, -54.88, -0.22, 0.04, 1.26
-6.89,11.71, -54.92, -0.17, 0.10, 0.91
-6.85,12.75, -54.67, -0.10, 0.19, 1.22
-6.21,13.50, -54.67, -0.05, 0.30, 1.24
-4.89,13.54, -55.08, 0.11, 0.23, 1.07
-4.42,14.04, -54.75, 0.17, 0.03, 0.77
-4.21,13.46, -54.88, 0.18, 0.04, 0.56
-3.73,13.33, -54.92, 0.20, 0.12, 0.63
-3.33,13.54, -55.29, 0.08, 0.23, 0.72
-2.68,14.00, -55.33, 0.01, 0.16, 0.94
-2.21,14.04, -55.75, 0.34, 0.77, 0.99
0.33,13.23, -56.54, 0.43, 0.69, 0.79
1.17,13.23, -56.79, 0.44, 0.49, 0.91
2.17,12.88, -57.17, 0.14, 0.47, 0.65
2.89,13.18, -56.96, 0.07, 0.19, 0.59
2.98,13.38, -57.00, 0.01, -0.18, 0.73
2.93,13.42, -57.04, -0.04, -0.31, 1.09
3.68,13.33, -57.17, 0.07, 0.00, 1.32
4.02,13.23, -57.00, 0.01, -0.01, 1.35
5.21,13.54, -56.75, -0.11, -0.06, 1.15
5.60,13.68, -57.04, -0.01, 0.16, 1.16
6.33,14.23, -57.00, -0.07, -0.05, 1.24
6.68,14.63, -57.17, -0.08, -0.29, 1.50
6.85,14.43, -57.38, 0.06, -0.48, 1.91
7.46,14.31, -57.58, 0.25, -0.48, 2.03
7.98,14.31, -57.04, -0.21, -0.77, 1.74
8.46,15.33, -56.75, -0.45, -0.77, 2.10
8.60,15.75, -56.46, -0.58, -0.82, 2.04
8.73,16.77, -55.96, -0.91, -0.90, 1.54
8.29,17.93, -55.04, -0.93, -0.90, 1.40
8.68,18.75, -55.04, -0.38, -0.54, 1.39
9.25,18.83, -55.00, 0.33, -0.17, 1.34
9.77,18.56, -55.54, 0.74, -0.04, 1.24
10.17,17.93, -55.71, 0.94, -0.10, 0.60
9.42,16.29, -55.71, 0.99, -0.77, 0.20
9.38,16.23, -56.17, 0.02, -0.43, 0.28
9.33,15.96, -55.88, -0.41, -0.24, 0.62
9.77,16.23, -56.04, -0.09, -0.16, 0.78
9.93,16.23, -56.17, 0.52, -0.08, 0.77
10.77,16.02, -56.75, 0.70, 0.21, 0.61
10.98,14.89, -57.17, 0.66, 0.12, 0.60
11.54,14.27, -57.63, 0.39, 0.19, 0.83
11.93,13.81, -57.42, 0.12, 0.24, 0.97
12.98,14.04, -57.38, -0.02, 0.25, 0.98
13.89,13.60, -57.50, -0.11, 0.25, 0.89
14.46,14.04, -57.33, -0.13, 0.32, 0.99
14.93,14.27, -57.38, 0.07, 0.39, 1.22
16.33,14.13, -57.38, 0.11, 0.45, 1.27
17.67,13.54, -57.17, 0.12, 0.38, 1.10
18.81,13.18, -57.08, 0.02, 0.51, 0.85
19.50,13.10, -57.29, 0.02, 0.42, 0.87
20.29,13.06, -57.21, -0.26, 0.39, 0.78
21.18,12.92, -57.04, -0.09, 0.39, 1.04
21.67,13.33, -56.96, 0.55, 0.34, 1.38
22.93,12.29, -57.58, 0.41, 0.41, 1.28
24.02,11.31, -57.25, 0.08, 0.45, 1.10
24.98,10.50, -57.08, 0.16, 0.42, 1.37
26.10,10.56, -57.33, 0.26, 0.45, 1.71
27.18,9.56, -56.88, -0.10, 0.35, 0.96
28.02,9.29, -56.88, -0.12, 0.30, 0.66
28.71,9.08, -56.83, 0.31, 0.23, 0.85
29.27,8.67, -57.08, 0.32, 0.20, 1.06
29.67,8.23, -57.25, 0.04, 0.24, 1.03
30.38,7.60, -56.83, 0.15, 0.27, 1.02
31.46,7.14, -56.58, 0.18, 0.28, 0.98
31.54,6.21, -56.96, -0.06, 0.26, 0.89
32.10,6.39, -56.75, 0.12, 0.12, 1.09
32.89,5.81, -56.63, -0.11, 0.04, 1.03
33.42,5.67, -56.46, -0.48, -0.08, 0.57
33.23,5.50, -56.75, -0.16, -0.24, 0.64
33.54,5.54, -56.50, -0.33, 0.11, 0.55
32.83,5.31, -56.79, 0.63, -0.54, 0.54
33.27,4.50, -56.83, 0.88, -0.38, 0.96
33.50,3.21, -57.04, -0.09, 0.42, 0.97
34.35,2.89, -56.96, -0.22, 0.88, 1.20
36.31,2.08, -56.50, -0.39, 0.72, 1.88
37.39,1.38, -55.58, -0.56, 0.89, 1.96
38.83,1.10, -55.21, 0.02, 0.46, 1.62
39.98,0.17, -55.46, 1.22, 0.20, 1.15
40.14,-2.81, -55.50, 1.84, 0.23, 1.37
40.46,-4.77, -55.13, 1.19, 0.50, 1.31
41.06,-6.39, -55.63, 0.13, 0.05, 1.55
41.43,-7.56, -55.46, -0.81, -0.64, 1.88
40.27,-7.68, -55.92, -0.72, -1.02, 1.80
39.58,-8.00, -56.21, -0.02, -0.40, 1.39
39.10,-8.46, -56.25, 0.34, 0.12, 1.36
39.58,-9.83, -56.46, 0.40, -0.05, 1.43
39.46,-11.39, -56.54, -0.26, -0.31, 1.76
39.46,-12.08, -56.42, -1.30, -0.53, 2.14
38.39,-11.46, -57.00, -0.62, -0.23, 1.80
38.35,-12.29, -57.13, -0.45, 0.31, 1.26
38.79,-11.85, -56.88, -0.91, 0.31, 1.22
38.79,-12.13, -56.38, -0.31, 0.49, 1.31
39.75,-12.29, -55.88, -0.09, 0.07, 1.57
39.18,-13.06, -56.13, 0.34, -0.08, 1.65
39.39,-14.27, -56.21, 0.08, 0.31, 1.55
39.63,-15.52, -56.08, 0.11, 0.25, 1.27
39.79,-15.96, -55.63, -0.04, 0.21, 1.11
39.75,-16.46, -55.50, -0.87, -0.15, 1.53
39.18,-16.54, -56.25, -0.40, 0.14, 1.63
39.23,-16.46, -55.88, -0.70, 0.30, 1.56
39.27,-16.92, -55.63, -0.56, 0.25, 1.25
39.46,-17.23, -55.67, -0.19, 0.30, 1.17
39.54,-17.98, -55.58, -0.12, 0.39, 1.45
39.75,-18.43, -55.54, -0.04, 0.57, 1.84
40.27,-18.96, -54.96, 0.42, 0.66, 1.66
40.58,-19.96, -54.71, -0.01, 0.25, 1.28
40.10,-20.98, -54.25, -0.62, 0.28, 1.25
40.31,-21.38, -54.67, -0.66, 0.26, 1.40
40.14,-21.79, -54.50, -0.49, 0.23, 1.67
40.06,-21.88, -54.46, -0.03, 0.22, 1.63
40.18,-24.02, -54.46, 0.72, 0.42, 1.49
40.27,-24.96, -53.38, 0.36, 0.94, 1.61
40.27,-26.13, -53.38, 0.26, 0.58, 1.44
40.39,-26.71, -53.04, 0.15, 0.44, 1.31
40.54,-27.25, -53.21, -0.00, 0.37, 1.27
40.58,-28.46, -52.58, 0.31, 0.43, 1.32
40.35,-29.43, -52.08, 0.26, 0.24, 1.40
40.54,-30.48, -51.63, 0.27, 0.15, 1.38
39.67,-31.85, -51.63, 0.24, 0.12, 1.40
39.18,-32.48, -51.46, 0.22, -0.13, 0.90
38.27,-33.10, -51.38, -0.07, -0.19, 0.81
38.02,-33.21, -51.58, 0.02, 0.03, 0.84
38.10,-33.83, -51.50, 0.11, -0.07, 0.89
36.93,-34.38, -51.71, 0.19, -0.24, 0.85
36.71,-34.63, -51.79, 0.35, -0.07, 0.79
36.18,-35.39, -51.50, 0.17, 0.05, 0.88
35.67,-35.67, -51.42, 0.03, -0.02, 0.97
35.14,-36.10, -51.79, -0.31, -0.21, 0.88
34.46,-35.75, -51.92, -0.35, -0.40, 0.78
33.71,-36.46, -51.92, -0.06, -0.30, 0.78
32.89,-36.64, -52.21, -0.08, -0.16, 0.73
32.46,-37.00, -52.54, -0.21, -0.09, 0.71
32.63,-36.79, -52.67, -0.09, -0.15, 0.84
31.71,-37.46, -52.46, -0.10, -0.01, 0.92
31.14,-36.96, -52.67, -0.47, 0.01, 0.67
31.06,-37.00, -52.63, -0.41, -0.02, 0.54
30.50,-36.64, -52.67, -0.03, 0.09, 0.66
30.50,-36.92, -52.58, 0.05, 0.12, 0.72
30.10,-37.46, -52.46, -0.19, 0.12, 0.71
29.85,-37.10, -52.71, 0.23, 0.11, 0.79
29.54,-37.73, -52.54, -0.04, -0.03, 0.89
28.89,-38.25, -52.83, 0.07, 0.11, 0.86
28.89,-38.48, -52.42, 0.19, 0.05, 0.68
28.63,-38.56, -52.50, 0.14, 0.01, 0.65
27.75,-39.25, -52.83, 0.09, -0.03, 0.80
27.54,-39.21, -52.29, 0.22, 0.01, 0.78
27.14,-39.88, -52.13, 0.15, -0.06, 0.62
26.75,-39.96, -52.42, 0.16, -0.16, 0.63
26.27,-40.31, -52.00, 0.06, -0.06, 0.62
25.67,-40.89, -52.04, -0.08, -0.01, 0.56
25.46,-40.85, -51.67, -0.02, 0.05, 0.51
25.50,-40.54, -52.00, -0.00, 0.04, 0.55
24.85,-40.98, -52.04, 0.08, -0.03, 0.43
25.02,-40.77, -52.08, 0.34, -0.09, 0.39
24.46,-41.48, -51.83, -0.17, 0.04, 0.52
24.06,-41.25, -52.04, -0.17, 0.17, 0.43
24.63,-41.21, -51.79, -0.24, 0.08, 0.37
24.33,-41.17, -52.17, -0.02, 0.06, 0.31
23.77,-41.67, -52.29, 0.11, -0.03, 0.25
24.18,-41.88, -52.08, 0.15, 0.03, 0.32
23.77,-42.18, -52.13, 0.01, 0.09, 0.36
23.77,-41.52, -51.96, -0.49, 0.13, 0.40
23.81,-41.52, -52.38, -0.31, 0.16, 0.35
23.18,-41.25, -52.54, -0.22, 0.04, 0.40
23.14,-41.63, -52.54, 0.05, 0.14, 0.41
23.10,-41.63, -52.08, 0.24, 0.10, 0.31
22.63,-41.48, -52.13, -0.04, -0.05, 0.32
22.54,-41.21, -52.17, -0.19, 0.12, 0.32
22.46,-41.52, -52.46, -0.17, 0.16, 0.42
22.46,-41.71, -52.21, 0.03, 0.06, 0.47
22.14,-41.52, -52.42, 0.18, 0.02, 0.41
21.81,-41.71, -52.29, -0.12, 0.06, 0.81
21.50,-41.98, -52.13, 0.09, 0.24, 0.90
20.93,-42.38, -52.33, -0.16, 0.10, 0.49
21.25,-41.88, -52.63, -0.31, -0.03, 0.11
20.89,-41.56, -52.46, 0.08, -0.14, 0.13
20.98,-41.67, -52.42, 0.13, -0.02, 0.10
20.81,-41.63, -52.46, 0.11, 0.00, 0.08
20.38,-42.29, -52.38, -0.06, 0.00, 0.04
20.67,-42.10, -52.50, -0.02, -0.07, -0.04
20.81,-42.10, -52.38, 0.11, -0.12, 0.01
20.25,-42.02, -52.42, -0.01, -0.08, 0.12
20.38,-42.14, -52.46, 0.14, -0.07, 0.39
20.02,-42.42, -52.13, 0.35, -0.09, 0.51
19.46,-42.92, -51.71, 0.24, -0.13, 0.37
19.18,-42.96, -52.13, -0.07, -0.08, 0.15
19.10,-43.14, -52.00, -0.17, -0.07, 0.15
18.98,-42.73, -52.04, -0.03, -0.10, 0.20
18.58,-43.18, -52.08, 0.18, -0.05, 0.06
18.46,-43.08, -52.08, -0.02, 0.02, -0.23
19.02,-42.56, -52.46, -0.17, 0.11, -0.35
19.10,-42.42, -52.13, -0.15, 0.12, -0.23
19.33,-42.33, -52.58, 0.01, -0.04, -0.05
    ];


magnetometer_data = raw_data(:,1:3); % uT
gyroscope_data = raw_data(:,4:6); % dps

% 设置数据比例
data_ratio = 1;

% 选择连续的数据段用于校准
total_samples = size(magnetometer_data, 1);
calibration_samples = round(total_samples * data_ratio);
start_index = randi(total_samples - calibration_samples + 1);
end_index = start_index + calibration_samples - 1;

mag_calibration_subset = magnetometer_data(start_index:end_index, :);
gyr_calibration_subset = gyroscope_data(start_index:end_index, :);

%% 椭球拟合法 (magcal)
[calibration_matrix, hard_iron_bias, expected_field_strength] = magcal(mag_calibration_subset, 'eye');

% 显示校准结果
fprintf('magcal 校准结果:\n');
fprintf('校准矩阵:\n');
disp(calibration_matrix);
fprintf('硬铁干扰 (偏置): [%.3f, %.3f, %.3f]\n', hard_iron_bias);
fprintf('预期磁场强度: %.3f\n', expected_field_strength);

% 应用校准
mag_calibrated_magcal = (mag_calibration_subset - hard_iron_bias) * calibration_matrix;

sampling_interval = 0.02;
[kf_hard_iron_bias, kf_state_history, kf_covariance_history] = kalman_filter_magnetometer_calibration(mag_calibration_subset, gyr_calibration_subset, sampling_interval);

fprintf('\n卡尔曼滤波法校准结果:\n');
fprintf('硬铁干扰 (偏置): [%.3f, %.3f, %.3f]\n', kf_hard_iron_bias);

% 应用卡尔曼滤波校准
mag_calibrated_kf = mag_calibration_subset - kf_hard_iron_bias';

%% 绘图比较

% 2D 比较图
figure('Name', '2D Comparisons');

subplot(2, 2, 1);
plot_2d_comparison(mag_calibration_subset, mag_calibrated_magcal, mag_calibrated_kf, 1, 2, 'X', 'Y');

subplot(2, 2, 2);
plot_2d_comparison(mag_calibration_subset, mag_calibrated_magcal, mag_calibrated_kf, 1, 3, 'X', 'Z');

subplot(2, 2, 3);
plot_2d_comparison(mag_calibration_subset, mag_calibrated_magcal, mag_calibrated_kf, 2, 3, 'Y', 'Z');

sgtitle('2D Comparisons of Magnetometer Calibration', 'FontSize', 16, 'FontWeight', 'bold');

% 绘制卡尔曼滤波收敛过程和硬磁估计
figure('Name', 'Kalman Filter Convergence and Hard Iron Estimation');

subplot(2, 1, 1);
plot(kf_covariance_history);
title('Kalman Filter Trace of P Matrix');
xlabel('Iteration');
ylabel('Trace(P)');

subplot(2, 1, 2);
plot(kf_state_history(:, 4:6));
title('Kalman Filter Hard Iron Estimation');
xlabel('Iteration');
ylabel('Hard Iron (uT)');
legend('X', 'Y', 'Z');

% 3D 比较图
figure('Name', '3D Comparison');
plot_3d_comparison(mag_calibration_subset, mag_calibrated_magcal, calibration_matrix, hard_iron_bias, expected_field_strength);

%% 评估指标（使用全部数据集）

% 应用校准到全部数据集
mag_calibrated_magcal_full = (magnetometer_data - hard_iron_bias) * calibration_matrix;
mag_calibrated_kf_full = magnetometer_data - kf_hard_iron_bias';

% 计算磁场模
mag_uncalibrated_magnitude = sqrt(sum(magnetometer_data.^2, 2));
mag_calibrated_magcal_magnitude = sqrt(sum(mag_calibrated_magcal_full.^2, 2));
mag_calibrated_kf_magnitude = sqrt(sum(mag_calibrated_kf_full.^2, 2));

% 计算标准差
std_uncalibrated = std(mag_uncalibrated_magnitude);
std_magcal = std(mag_calibrated_magcal_magnitude);
std_kf = std(mag_calibrated_kf_magnitude);

% 计算改善百分比
improvement_magcal = (std_uncalibrated - std_magcal) / std_uncalibrated * 100;
improvement_kf = (std_uncalibrated - std_kf) / std_uncalibrated * 100;

% 打印结果
fprintf('Samples: %d (%.1f%%)\n', total_samples, data_ratio * 100);
fprintf('Method      Std Dev    Improvement\n');
fprintf('-------------------------------------\n');
fprintf('Uncalibrated %.4f    -\n', std_uncalibrated);
fprintf('Magcal       %.4f    %.2f%%\n', std_magcal, improvement_magcal);
fprintf('Kalman       %.4f    %.2f%%\n', std_kf, improvement_kf);

%% Helper functions
function plot_3d_comparison(uncalibrated, calibrated_magcal, calibration_matrix, hard_iron_bias, expected_field_strength)
    % 创建图形并设置属性
    ax = gca; % 获取当前坐标轴
    hold(ax, 'on');
    
    % 绘制未校准数据
    scatter3(ax, uncalibrated(:,1), uncalibrated(:,2), uncalibrated(:,3), ...
        10, [0.7 0.7 0.7], 'filled', 'MarkerEdgeColor', 'none', 'MarkerFaceAlpha', 0.5);
    
    % 绘制magcal校准后的数据
    scatter3(ax, calibrated_magcal(:,1), calibrated_magcal(:,2), calibrated_magcal(:,3), ...
        10, 'r', 'filled', 'MarkerEdgeColor', 'none', 'MarkerFaceAlpha', 0.5);
    
    % 绘制拟合的椭球（半透明网格图）
    [x, y, z] = ellipsoid(0, 0, 0, 1, 1, 1, 20);
    x = x .* (expected_field_strength / sqrt(calibration_matrix(1,1))) + hard_iron_bias(1);
    y = y .* (expected_field_strength / sqrt(calibration_matrix(2,2))) + hard_iron_bias(2);
    z = z .* (expected_field_strength / sqrt(calibration_matrix(3,3))) + hard_iron_bias(3);
    ellipsoid_surface = mesh(ax, x, y, z, 'EdgeColor', [0.3 0.3 1], 'FaceAlpha', 0, 'EdgeAlpha', 0.3);
    
    % 绘制校正后的球体（半透明网格图）
    [x, y, z] = sphere(20);
    x = x * expected_field_strength; y = y * expected_field_strength; z = z * expected_field_strength;
    sphere_surface = mesh(ax, x, y, z, 'EdgeColor', [1 0.3 0.3], 'FaceAlpha', 0, 'EdgeAlpha', 0.3);
    
    % 设置光照以增强3D效果
    light('Position', [1 1 1], 'Style', 'infinite');
    lighting gouraud
    
    % 设置图形属性
    grid(ax, 'on');
    axis(ax, 'equal');
    xlabel(ax, 'X (uT)', 'FontWeight', 'bold');
    ylabel(ax, 'Y (uT)', 'FontWeight', 'bold');
    zlabel(ax, 'Z (uT)', 'FontWeight', 'bold');
    title(ax, "Uncalibrated vs Calibrated Magnetometer Measurements (magcal)", 'FontWeight', 'bold');
    
    % 添加图例
    legend(ax, 'Uncalibrated', 'Calibrated (magcal)', 'Fitted Ellipsoid', 'Corrected Sphere', ...
        'Location', 'southoutside', 'Orientation', 'horizontal');
    
    % 设置视角
    view(ax, 3);
    
    % 添加旋转控制
    rotate3d(ax, 'on');
    
    hold(ax, 'off');
end





function plot_2d_comparison(uncalibrated, calibrated_magcal, calibrated_kf, x_index, y_index, x_label, y_label)
plot(uncalibrated(:,x_index), uncalibrated(:,y_index), ...
    'LineStyle', 'none', 'Marker', '.', 'MarkerSize', 5, 'Color', [0.5 0.5 0.5]);
hold on;
plot(calibrated_magcal(:,x_index), calibrated_magcal(:,y_index), ...
    'LineStyle', 'none', 'Marker', '.', 'MarkerSize', 5, 'Color', 'r');
plot(calibrated_kf(:,x_index), calibrated_kf(:,y_index), ...
    'LineStyle', 'none', 'Marker', '.', 'MarkerSize', 5, 'Color', 'g');
grid on;
axis equal;
xlabel([x_label ' (uT)'], 'FontSize', 12);
ylabel([y_label ' (uT)'], 'FontSize', 12);
legend('Uncalibrated', 'magcal', 'Kalman Filter', 'Location', 'best', 'FontSize', 10);
title(['Plane ' x_label '-' y_label], 'FontSize', 14, 'FontWeight', 'bold');
hold off;
end

function [hard_iron_bias, state_history, covariance_history] = kalman_filter_magnetometer_calibration(magnetometer_data, gyroscope_data, sampling_interval)
% 初始化状态向量
state = zeros(6,1);
state(1:3) = magnetometer_data(1,:)'; % 初始磁场估计
state(4:6) = [0; 0; 0];     % 初始偏置估计

% 初始化协方差矩阵
covariance = diag([1, 1, 1, 10, 10, 10]);

% 过程噪声协方差矩阵
process_noise = diag([0.1, 0.1, 0.1, 0, 0, 0]);

% 测量噪声协方差矩阵
measurement_noise = diag([1, 1, 1]);

data_length = size(magnetometer_data, 1);
state_history = zeros(data_length, 6);
covariance_history = zeros(data_length, 1);

for i = 1:data_length
    gyro = deg2rad(gyroscope_data(i,:)'); % 转换为弧度/秒
    measurement = magnetometer_data(i,:)';

    % 状态转移矩阵
    skew_matrix = skew_symmetric(gyro);
    state_transition = [-skew_matrix, skew_matrix; zeros(3,6)];
    state_transition = eye(6) + state_transition * sampling_interval;

    % 预测步骤
    state = state_transition * state;
    covariance = state_transition * covariance * state_transition' + process_noise * sampling_interval;

    % 更新步骤
    measurement_matrix = [eye(3), zeros(3,3)];

    innovation_covariance = measurement_matrix * covariance * measurement_matrix' + measurement_noise;
    kalman_gain = covariance * measurement_matrix' / innovation_covariance;

    innovation = measurement - measurement_matrix * state;
    state = state + kalman_gain * innovation;
    covariance = (eye(6) - kalman_gain * measurement_matrix) * covariance;

    % 存储结果
    state_history(i,:) = state';
    covariance_history(i) = trace(covariance);
end

hard_iron_bias = state(4:6); % 最终估计的偏置
end

function skew_matrix = skew_symmetric(vector)
% 创建斜对称矩阵
skew_matrix = [0, -vector(3), vector(2);
    vector(3), 0, -vector(1);
    -vector(2), vector(1), 0];
end